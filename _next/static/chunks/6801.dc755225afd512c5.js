(()=>{"use strict";function e(e,t,s,r,a){return{id:e,speed:s?s/1024/1024/(t/1e3):0,durationMs:t,durationSec:t/1e3,processedBytes:s,totalBytes:r,fileName:a}}async function t(e,t,s,r){let a,i,n,o="",l=0,c=0,h=0,R=null,f={lat:"NaN",lng:"NaN"};try{let t="string"==typeof e?JSON.parse(e):e;if(t&&Array.isArray(t.tags)){let e=t.tags;l=Number(t.baseOffset)||0,c=Number(t.dataSize)||0,h=Number(t.endOffset)||0,a=t.byteOrder?String(t.byteOrder):void 0,i=void 0!==t.firstIfdOffset&&null!==t.firstIfdOffset?Number(t.firstIfdOffset):void 0,n=Array.isArray(t.ifdInfo)?t.ifdInfo:void 0,R=e.map(e=>({tag:e.tag,ifd:e.ifd,data:e.data,type:e.type,offset:Number.isFinite(Number(e.offset))?Number(e.offset):void 0,length:Number.isFinite(Number(e.length))?Number(e.length):void 0,isFar:!!e.isFar})),t.thumbnail&&(o=t.thumbnail),t.location&&(f={lat:String(t.location.lat||"NaN"),lng:String(t.location.lng||"NaN")})}}catch(e){console.error("[exifParser] Parse error:",e)}return{thumbnail:o,baseOffset:l,dataSize:c,endOffset:h,byteOrder:a,firstIfdOffset:i,location:f,ifdInfos:n,tagInfos:R}}class s{setupReadBlockSync(){let e=(e,t,s)=>{try{this.totalReadCount++,this.totalReadBytes+=s,this.currentFileSize>0&&void 0!==this.currentRequestId&&this.totalReadBytes-this.lastProgressReportBytes>=this.progressReportInterval&&(this.sendSearchProgress(),this.lastProgressReportBytes=this.totalReadBytes);let r=e.slice(t,t+s),a=this.syncReader.readAsArrayBuffer(r);return new Uint8Array(a)}catch(e){return console.error("[Worker] readBlockSync error:",e),null}};self.readBlockSync=e}initProgress(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this.totalReadCount=0,this.totalReadBytes=0,this.lastProgressReportBytes=0,this.currentFileSize=e,this.currentFileName=s,this.currentRequestId=t,this.progressReportInterval=(e<0x6400000?{bytes:Math.max(1048576,Math.floor(.01*e)),ms:500}:e<0x40000000?{bytes:Math.floor(.02*e),ms:1e3}:{bytes:Math.floor(.05*e),ms:2e3}).bytes}sendSearchProgress(){if(void 0===this.currentRequestId)return;let t=performance.now();self.postMessage({status:"PROGRESS",taskType:"SEARCH_HEX",stats:e(this.currentRequestId,t,this.totalReadBytes,this.currentFileSize,this.currentFileName)})}async initWasm(){if(this.wasmReady)return void self.postMessage({status:"WASM_READY"});if(!this.wasmInitializing){this.wasmInitializing=!0;try{if(this.goInstance){if(this.goInstance.exit)try{this.goInstance.exit(0)}catch(e){}this.goInstance=null}if(this.wasmSearchFunc=null,this.wasmExifFunc=null,this.wasmReady=!1,self.importScripts("/js/wasm_exec.js"),"function"!=typeof self.Go)throw Error("Go class not found after loading wasm_exec.js");let e=new self.Go;if(this.goInstance=e,!this.wasmPath)throw Error("WASM_PATH_NOT_CONFIGURED: NEXT_PUBLIC_WASM_PATH environment variable is not set");let t=await fetch(this.wasmPath);if(!t.ok)throw Error('WASM_LOAD_FAILED: Failed to load WASM from "'.concat(this.wasmPath,'" (HTTP ').concat(t.status," ").concat(t.statusText,")"));let s=await WebAssembly.instantiateStreaming(Promise.resolve(t),e.importObject),r=new Promise(e=>{self.addEventListener("wasmReady",()=>e(),{once:!0})});e.run(s.instance),await Promise.race([r,new Promise((e,t)=>setTimeout(()=>t(Error("WASM INIT TIMEOUT")),1e4))]);let a=self;if(this.wasmSearchFunc=a.searchFunc,this.wasmExifFunc=a.exifFunc,!this.wasmSearchFunc||!this.wasmExifFunc)throw Error("WASM functions not registered");this.wasmReady=!0,this.wasmInitializing=!1,self.postMessage({status:"WASM_READY"})}catch(e){this.wasmReady=!1,this.wasmInitializing=!1,console.error("[Worker] WASM initialization error:",e),self.postMessage({status:"ERROR",errorCode:"WASM_LOAD_FAILED"})}}}async processExif(s,r){try{if(this.initProgress(r.size,s),!this.wasmReady||!this.wasmExifFunc)return void self.postMessage({id:s,status:"ERROR",taskType:"PROCESS_EXIF",errorCode:"WASM_NOT_READY"});let a=performance.now(),i=this.wasmExifFunc(r),n=performance.now();if(i.error)return void self.postMessage({id:s,status:"ERROR",taskType:"PROCESS_EXIF",errorCode:"EXIF_PARSE_ERROR"});let o=await t(i.exifData||"[]",r,i.mimeType||"",this.syncReader);self.postMessage({status:"SUCCESS",taskType:"PROCESS_EXIF",stats:e(s,n-a,this.totalReadBytes,this.currentFileSize,r.name),data:{hasExif:i.hasExif||!1,mimeType:i.mimeType,extension:i.extension,exifInfo:o}})}catch(e){self.postMessage({id:s,status:"ERROR",taskType:"PROCESS_EXIF",errorCode:"EXIF_ERROR"})}}async search(t,s,r,a){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(this.initProgress(s.size,t,s.name),!this.wasmReady||!this.wasmSearchFunc)return void self.postMessage({id:t,status:"ERROR",taskType:"HEX"===a?"SEARCH_HEX":"SEARCH_ASCII",errorCode:"WASM_NOT_READY"});try{let n=performance.now(),o=this.wasmSearchFunc(s,r,{ignoreCase:"ASCII"===a&&i,maxResults:1e3}),l=performance.now();if(o.error)return void self.postMessage({id:t,status:"ERROR",taskType:"HEX"===a?"SEARCH_HEX":"SEARCH_ASCII",errorCode:"SEARCH_WASM_ERROR"});let c=(o.indices||[]).map(e=>({index:e,offset:r.length}));self.postMessage({status:"SUCCESS",taskType:"HEX"===a?"SEARCH_HEX":"SEARCH_ASCII",stats:e(t,l-n,this.totalReadBytes,this.currentFileSize,s.name),data:{indices:c}})}catch(e){self.postMessage({id:t,status:"ERROR",taskType:"HEX"===a?"SEARCH_HEX":"SEARCH_ASCII",errorCode:"SEARCH_ERROR"})}}async handle(e){let{type:t,id:s,file:r,pattern:a,ignoreCase:i}=e;switch(t){case"SEARCH_HEX":case"SEARCH_ASCII":r&&a&&await this.search(s,r,a,"SEARCH_HEX"===t?"HEX":"ASCII",i);break;case"PROCESS_EXIF":r&&await this.processExif(s,r)}}constructor(){this.totalReadCount=0,this.totalReadBytes=0,this.currentFileSize=0,this.currentFileName="",this.lastProgressReportBytes=0,this.progressReportInterval=4194304,this.syncReader=new FileReaderSync,this.wasmReady=!1,this.wasmInitializing=!1,this.wasmSearchFunc=null,this.wasmExifFunc=null,this.goInstance=null,this.wasmPath="/wasm/ice_app_260212.wasm"}}self.addEventListener("error",e=>{self.postMessage({status:"ERROR",errorCode:"WORKER_ERROR"})}),self.addEventListener("unhandledrejection",e=>{self.postMessage({status:"ERROR",errorCode:"WORKER_ERROR"})});let r=new s;r.setupReadBlockSync(),self.addEventListener("message",e=>{r.handle(e.data)}),r.initWasm()})(),_N_E={};