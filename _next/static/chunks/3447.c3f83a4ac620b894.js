(()=>{"use strict";self.addEventListener("error",e=>{var r;self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:(null==(r=e.error)?void 0:r.message)||e.message})}),self.addEventListener("unhandledrejection",e=>{self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:"Promise rejection: ".concat(e.reason)})});let e=[],r=0,s=!1,t=new Set,o=!1,a=!1,l=null,n=null,i=null;async function f(){if(o)return void self.postMessage({type:"WASM_READY"});if(!a){a=!0;try{if(i){if(i.exit)try{i.exit(0)}catch(e){}i=null}if(l=null,n=null,o=!1,self.importScripts("/js/wasm_exec.js"),"function"!=typeof self.Go)throw Error("Go class not found after loading wasm_exec.js");let e=new self.Go;i=e;let r=await WebAssembly.instantiateStreaming(fetch("/wasm/ice_app.wasm"),e.importObject),s=new Promise(e=>{self.addEventListener("wasmReady",()=>e(),{once:!0})});if(e.run(r.instance),await Promise.race([s,new Promise((e,r)=>setTimeout(()=>r(Error("WASM INIT TIMEOUT")),1e4))]),l=self.searchFunc,n=self.exifFunc,!l||!n)throw Error("WASM FUNCTIONS NOT FOUND");o=!0,a=!1,self.postMessage({type:"WASM_READY"})}catch(r){let e=r instanceof Error?r.message:String(r);o=!1,a=!1,i=null,self.postMessage({type:"WASM_ERROR",error:e})}}}async function R(){for(;r<8&&e.length>0;){e.sort((e,r)=>e.priority-r.priority),r++;let s=e.shift();try{let e=s.file.slice(s.offset,s.offset+s.length),r=await e.arrayBuffer();self.postMessage({type:"CHUNK_DATA",offset:s.offset,buffer:r},[r])}catch(e){self.postMessage({type:"ERROR",error:e.message,offset:s.offset})}finally{r--,R()}}}async function E(e){let r=Date.now();for(;!o&&Date.now()-r<3e3;)await new Promise(e=>setTimeout(e,100));if(!o||!n)return void self.postMessage({type:"EXIF_ERROR",errorCode:"WASM_NOT_READY",error:"WASM module not ready"});try{let r=n(e);r.error?self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_PARSE_ERROR",error:r.error}):self.postMessage({type:"EXIF_RESULT",result:r})}catch(e){self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_ERROR",error:e.message})}}async function c(e,r,a){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0,f=r.length-1,R=e.size,E=[],c=new Set,S=0,_=0,u=Date.now();for(;!o&&Date.now()-u<3e3;)await new Promise(e=>setTimeout(e,100));if(!o||!l)return void self.postMessage({type:"HEX"===a?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:i,errorCode:"WASM_NOT_READY",error:"WASM module not ready"});let A=null,d=async r=>{let s=Math.max(0,r-f),t=Math.min(0x1000000+f,R-s),o=e.slice(s,s+t);return new Uint8Array(await o.arrayBuffer())},p=await d(S),y=0;for(;S<R&&_<1e3;){if(s&&void 0!==i&&t.has(i))return;let e=Math.floor(S/R*100);e>y&&(y=e,self.postMessage({type:"SEARCH_PROGRESS",searchId:i,progress:e}));let o=S+0x1000000;o<R&&!A&&(A=d(o));let u=[];try{let e={ignoreCase:"ASCII"===a&&n,maxResults:1e3-_},s=l(p,r,e);if(s.error)return void self.postMessage({type:"HEX"===a?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:i,errorCode:"SEARCH_WASM_ERROR",error:s.error});u=s.indices||[]}catch(e){self.postMessage({type:"HEX"===a?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:i,errorCode:"SEARCH_WASM_ERROR",error:e.message||"WASM search failed"});return}let C=Math.max(0,S-f);for(let e of u){let s=C+e;if(!c.has(s)&&(c.add(s),E.push({index:s,offset:r.length}),++_>=1e3))break}if(_>=1e3)break;if(S+=0x1000000,A){try{p=await A}catch(e){console.error("[Worker] Prefetch chunk error:",e);break}A=null}else break}void 0!==i&&t.has(i)||self.postMessage({type:"HEX"===a?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:E,searchId:i,usedWasm:!0})}f(),self.addEventListener("message",r=>{let{type:l,file:n,offset:i,length:S,priority:_=i,pattern:u,ignoreCase:A,searchId:d,imageData:p}=r.data;switch(l){case"CANCEL_SEARCH":s=!0,void 0!==d&&t.add(d);break;case"RELOAD_WASM":a||(o=!1,f());break;case"SEARCH_HEX":case"SEARCH_ASCII":s=!1,void 0!==d&&t.forEach(e=>{e<d-10&&t.delete(e)}),c(n,u,"SEARCH_HEX"===l?"HEX":"ASCII",A,d);break;case"READ_CHUNK":e.push({file:n,offset:i,length:S,priority:_}),R();break;case"PROCESS_EXIF":E(p)}})})(),_N_E={};