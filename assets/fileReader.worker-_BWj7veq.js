(function(){"use strict";self.addEventListener("error",e=>{var s;console.error("[Worker] Uncaught error:",e.error),self.postMessage({type:"WASM_ERROR",error:`Worker error: ${((s=e.error)==null?void 0:s.message)||e.message}`})}),self.addEventListener("unhandledrejection",e=>{console.error("[Worker] Unhandled promise rejection:",e.reason),self.postMessage({type:"WASM_ERROR",error:`Promise rejection: ${e.reason}`})});const L=8,w=[];let M=0,W=!1,S=new Set,a=!1,R=!1,A=null,g=null,f=null;async function k(){if(a){self.postMessage({type:"WASM_READY"});return}if(R){console.log("[Worker] WASM initialization already in progress");return}R=!0;try{if(f){if(console.log("[Worker] Cleaning up previous WASM instance"),f.exit)try{f.exit(0)}catch(t){console.warn("[Worker] Error during Go instance cleanup:",t)}f=null}if(A=null,g=null,a=!1,self.importScripts("/js/wasm_exec.js"),typeof self.Go!="function")throw new Error("Go class not found after loading wasm_exec.js");const e=new self.Go;f=e;const s=await WebAssembly.instantiateStreaming(fetch("/wasm/ice_app.wasm"),e.importObject),r=new Promise(t=>{self.addEventListener("wasmReady",()=>t(),{once:!0})});if(e.run(s.instance),await Promise.race([r,new Promise((t,o)=>setTimeout(()=>o(new Error("WASM 초기화 타임아웃")),1e4))]),A=self.searchFunc,g=self.exifFunc,!A||!g)throw new Error("WASM 함수가 등록되지 않았습니다");a=!0,R=!1,console.log("[Worker] ✅ WASM loaded successfully"),self.postMessage({type:"WASM_READY"})}catch(e){const s=e instanceof Error?e.message:String(e);console.error("[Worker] ❌ WASM load failed:",s),a=!1,R=!1,f=null,self.postMessage({type:"WASM_ERROR",error:s})}}k();async function H(){for(;M<L&&w.length>0;){w.sort((s,r)=>s.priority-r.priority),M++;const e=w.shift();try{const r=await e.file.slice(e.offset,e.offset+e.length).arrayBuffer(),t=new Uint8Array(r);self.postMessage({type:"CHUNK_DATA",offset:e.offset,data:t})}catch(s){self.postMessage({type:"ERROR",error:s.message,offset:e.offset})}finally{M--,H()}}}self.addEventListener("message",e=>{const{type:s,file:r,offset:t,length:o,priority:b=t,pattern:p,ignoreCase:d,searchId:l,imageData:_}=e.data;switch(s){case"CANCEL_SEARCH":W=!0,l!==void 0&&(S.add(l),console.log(`[Worker] Search ${l} cancelled`));break;case"RELOAD_WASM":R?console.warn("[Worker] WASM is already initializing, ignoring RELOAD_WASM"):(a=!1,k());break;case"SEARCH_HEX":case"SEARCH_ASCII":W=!1,l!==void 0&&S.forEach(i=>{i<l-10&&S.delete(i)}),X(r,p,s==="SEARCH_HEX"?"HEX":"ASCII",d,l);break;case"READ_CHUNK":w.push({file:r,offset:t,length:o,priority:b}),H();break;case"PROCESS_EXIF":O(_);break}});async function O(e){const s=Date.now();for(;!a&&Date.now()-s<3e3;)await new Promise(r=>setTimeout(r,100));if(!a||!g){self.postMessage({type:"EXIF_ERROR",error:"WASM not ready"});return}try{const r=g(e);r.error?self.postMessage({type:"EXIF_ERROR",error:r.error}):self.postMessage({type:"EXIF_RESULT",result:r})}catch(r){self.postMessage({type:"EXIF_ERROR",error:r.message})}}async function X(e,s,r,t=!1,o){const p=s.length-1,d=e.size,l=[],_=new Set;let i=0,h=0;const m=1e3,x=Date.now();for(;!a&&Date.now()-x<3e3;)await new Promise(u=>setTimeout(u,100));if(!a||!A){console.error("[Worker] WASM not ready, search aborted"),self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,error:"WASM not ready"});return}console.log("[Worker] Search using WASM");let y=null;const I=async u=>{const E=Math.max(0,u-p),C=Math.min(16777216+p,d-E),n=await e.slice(E,E+C).arrayBuffer();return new Uint8Array(n)};let U=await I(i);for(;i<d&&h<m;){if(W&&o!==void 0&&S.has(o)){console.log(`[Worker] Search ${o} aborted`);return}const u=i+16777216;u<d&&!y&&(y=I(u));let E=[];try{const c={ignoreCase:r==="ASCII"?t:!1,maxResults:m-h},n=A(U,s,c);if(n.error){console.error("[Worker] WASM search error:",n.error),self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,error:n.error});return}E=n.indices||[]}catch(c){console.error("[Worker] WASM search error:",c),self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,error:"WASM search failed"});return}const C=Math.max(0,i-p);for(const c of E){const n=C+c;if(!_.has(n)&&(_.add(n),l.push({index:n,offset:s.length}),h++,h>=m))break}if(h>=m)break;if(i+=16777216,y){try{U=await y}catch(c){console.error("[Worker] Prefetch chunk error:",c);break}y=null}else break}(o===void 0||!S.has(o))&&self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:l,searchId:o,usedWasm:!0})}})();
