(function(){"use strict";self.addEventListener("error",e=>{var s;self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:((s=e.error)==null?void 0:s.message)||e.message})}),self.addEventListener("unhandledrejection",e=>{self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:`Promise rejection: ${e.reason}`})});const x=8,d=[];let M=0,H=!1,S=new Set,a=!1,_=!1,A=null,C=null,R=null;async function O(){if(a){self.postMessage({type:"WASM_READY"});return}if(!_){_=!0;try{if(R){if(R.exit)try{R.exit(0)}catch{}R=null}if(A=null,C=null,a=!1,self.importScripts("/js/wasm_exec.js"),typeof self.Go!="function")throw new Error("Go class not found after loading wasm_exec.js");const e=new self.Go;R=e;const s=await WebAssembly.instantiateStreaming(fetch("/wasm/ice_app.wasm"),e.importObject),t=new Promise(r=>{self.addEventListener("wasmReady",()=>r(),{once:!0})});if(e.run(s.instance),await Promise.race([t,new Promise((r,o)=>setTimeout(()=>o(new Error("WASM INIT TIMEOUT")),1e4))]),A=self.searchFunc,C=self.exifFunc,!A||!C)throw new Error("WASM FUNCTIONS NOT FOUND");a=!0,_=!1,self.postMessage({type:"WASM_READY"})}catch(e){const s=e instanceof Error?e.message:String(e);a=!1,_=!1,R=null,self.postMessage({type:"WASM_ERROR",error:s})}}}O();async function I(){for(;M<x&&d.length>0;){d.sort((s,t)=>s.priority-t.priority),M++;const e=d.shift();try{const t=await e.file.slice(e.offset,e.offset+e.length).arrayBuffer();self.postMessage({type:"CHUNK_DATA",offset:e.offset,buffer:t},[t])}catch(s){self.postMessage({type:"ERROR",error:s.message,offset:e.offset})}finally{M--,I()}}}self.addEventListener("message",e=>{const{type:s,file:t,offset:r,length:o,priority:T=r,pattern:m,ignoreCase:E,searchId:l,imageData:w}=e.data;switch(s){case"CANCEL_SEARCH":H=!0,l!==void 0&&S.add(l);break;case"RELOAD_WASM":_||(a=!1,O());break;case"SEARCH_HEX":case"SEARCH_ASCII":H=!1,l!==void 0&&S.forEach(n=>{n<l-10&&S.delete(n)}),N(t,m,s==="SEARCH_HEX"?"HEX":"ASCII",E,l);break;case"READ_CHUNK":d.push({file:t,offset:r,length:o,priority:T}),I();break;case"PROCESS_EXIF":L(w);break}});async function L(e){const s=Date.now(),t=3e3;for(;!a&&Date.now()-s<t;)await new Promise(r=>setTimeout(r,100));if(!a||!C){self.postMessage({type:"EXIF_ERROR",errorCode:"WASM_NOT_READY",error:"WASM module not ready"});return}try{const r=C(e);r.error?self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_PARSE_ERROR",error:r.error}):self.postMessage({type:"EXIF_RESULT",result:r})}catch(r){self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_ERROR",error:r.message})}}async function N(e,s,t,r=!1,o){const m=s.length-1,E=e.size,l=[],w=new Set;let n=0,p=0;const y=1e3,F=Date.now(),k=3e3;for(;!a&&Date.now()-F<k;)await new Promise(i=>setTimeout(i,100));if(!a||!A){self.postMessage({type:t==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"WASM_NOT_READY",error:"WASM module not ready"});return}let g=null;const b=async i=>{const u=Math.max(0,i-m),h=Math.min(16777216+m,E-u),f=await e.slice(u,u+h).arrayBuffer();return new Uint8Array(f)};let U=await b(n),X=0;for(;n<E&&p<y;){if(H&&o!==void 0&&S.has(o))return;const i=Math.floor(n/E*100);i>X&&(X=i,self.postMessage({type:"SEARCH_PROGRESS",searchId:o,progress:i}));const u=n+16777216;u<E&&!g&&(g=b(u));let h=[];try{const f={ignoreCase:t==="ASCII"?r:!1,maxResults:y-p},c=A(U,s,f);if(c.error){self.postMessage({type:t==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"SEARCH_WASM_ERROR",error:c.error});return}h=c.indices||[]}catch(f){self.postMessage({type:t==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"SEARCH_WASM_ERROR",error:f.message||"WASM search failed"});return}const W=Math.max(0,n-m);for(const f of h){const c=W+f;if(!w.has(c)&&(w.add(c),l.push({index:c,offset:s.length}),p++,p>=y))break}if(p>=y)break;if(n+=16777216,g){try{U=await g}catch{break}g=null}else break}(o===void 0||!S.has(o))&&self.postMessage({type:t==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:l,searchId:o,usedWasm:!0})}})();
