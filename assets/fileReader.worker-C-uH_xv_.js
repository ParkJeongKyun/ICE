(function(){"use strict";self.addEventListener("error",e=>{var s;self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:((s=e.error)==null?void 0:s.message)||e.message})}),self.addEventListener("unhandledrejection",e=>{self.postMessage({type:"ERROR",errorCode:"WORKER_ERROR",error:`Promise rejection: ${e.reason}`})});const x=8,g=[];let M=0,H=!1,S=new Set,a=!1,_=!1,A=null,C=null,R=null;async function O(){if(a){self.postMessage({type:"WASM_READY"});return}if(!_){_=!0;try{if(R){if(R.exit)try{R.exit(0)}catch{}R=null}if(A=null,C=null,a=!1,self.importScripts("/js/wasm_exec.js"),typeof self.Go!="function")throw new Error("Go class not found after loading wasm_exec.js");const e=new self.Go;R=e;const s=await WebAssembly.instantiateStreaming(fetch("/wasm/ice_app.wasm"),e.importObject),r=new Promise(t=>{self.addEventListener("wasmReady",()=>t(),{once:!0})});if(e.run(s.instance),await Promise.race([r,new Promise((t,o)=>setTimeout(()=>o(new Error("WASM 초기화 타임아웃")),1e4))]),A=self.searchFunc,C=self.exifFunc,!A||!C)throw new Error("WASM 함수가 등록되지 않았습니다");a=!0,_=!1,self.postMessage({type:"WASM_READY"})}catch(e){const s=e instanceof Error?e.message:String(e);a=!1,_=!1,R=null,self.postMessage({type:"WASM_ERROR",error:s})}}}O();async function I(){for(;M<x&&g.length>0;){g.sort((s,r)=>s.priority-r.priority),M++;const e=g.shift();try{const r=await e.file.slice(e.offset,e.offset+e.length).arrayBuffer(),t=new Uint8Array(r);self.postMessage({type:"CHUNK_DATA",offset:e.offset,data:t})}catch(s){self.postMessage({type:"ERROR",error:s.message,offset:e.offset})}finally{M--,I()}}}self.addEventListener("message",e=>{const{type:s,file:r,offset:t,length:o,priority:b=t,pattern:m,ignoreCase:E,searchId:l,imageData:w}=e.data;switch(s){case"CANCEL_SEARCH":H=!0,l!==void 0&&S.add(l);break;case"RELOAD_WASM":_||(a=!1,O());break;case"SEARCH_HEX":case"SEARCH_ASCII":H=!1,l!==void 0&&S.forEach(n=>{n<l-10&&S.delete(n)}),k(r,m,s==="SEARCH_HEX"?"HEX":"ASCII",E,l);break;case"READ_CHUNK":g.push({file:r,offset:t,length:o,priority:b}),I();break;case"PROCESS_EXIF":L(w);break}});async function L(e){const s=Date.now(),r=3e3;for(;!a&&Date.now()-s<r;)await new Promise(t=>setTimeout(t,100));if(!a||!C){self.postMessage({type:"EXIF_ERROR",errorCode:"WASM_NOT_READY",error:"WASM module not ready"});return}try{const t=C(e);t.error?self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_PARSE_ERROR",error:t.error}):self.postMessage({type:"EXIF_RESULT",result:t})}catch(t){self.postMessage({type:"EXIF_ERROR",errorCode:"EXIF_ERROR",error:t.message})}}async function k(e,s,r,t=!1,o){const m=s.length-1,E=e.size,l=[],w=new Set;let n=0,p=0;const y=1e3,F=Date.now(),P=3e3;for(;!a&&Date.now()-F<P;)await new Promise(f=>setTimeout(f,100));if(!a||!A){self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"WASM_NOT_READY",error:"WASM module not ready"});return}let d=null;const X=async f=>{const u=Math.max(0,f-m),h=Math.min(16777216+m,E-u),i=await e.slice(u,u+h).arrayBuffer();return new Uint8Array(i)};let T=await X(n),U=0;for(;n<E&&p<y;){if(H&&o!==void 0&&S.has(o))return;const f=Math.floor(n/E*100);f>U&&(U=f,self.postMessage({type:"SEARCH_PROGRESS",searchId:o,progress:f}));const u=n+16777216;u<E&&!d&&(d=X(u));let h=[];try{const i={ignoreCase:r==="ASCII"?t:!1,maxResults:y-p},c=A(T,s,i);if(c.error){self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"SEARCH_WASM_ERROR",error:c.error});return}h=c.indices||[]}catch(i){self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:null,searchId:o,errorCode:"SEARCH_WASM_ERROR",error:i.message||"WASM search failed"});return}const W=Math.max(0,n-m);for(const i of h){const c=W+i;if(!w.has(c)&&(w.add(c),l.push({index:c,offset:s.length}),p++,p>=y))break}if(p>=y)break;if(n+=16777216,d){try{T=await d}catch{break}d=null}else break}(o===void 0||!S.has(o))&&self.postMessage({type:r==="HEX"?"SEARCH_RESULT_HEX":"SEARCH_RESULT_ASCII",results:l,searchId:o,usedWasm:!0})}})();
